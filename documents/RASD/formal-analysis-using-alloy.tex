% Definizione di un colore verde scuro personalizzato
\definecolor{darkgreen}{rgb}{0,0.5,0}  % Verde scuro RGB


% Definizione dello stile per il codice Alloy
\lstdefinelanguage{Alloy}{
    keywords={all, no, some, one, implies, and, in, not, lone, var},
    keywordstyle=\color{blue}\bfseries,
    morekeywords={assert, sig, abstract, extends, pred, run, for, but, let, set, fact},
    sensitive=true,
    comment=[l]{--},
    commentstyle=\color{darkgreen}\itshape,
    morestring=[b]",
    stringstyle=\color{red}
}

\lstset{
    language=Alloy,
    basicstyle=\ttfamily\small,
    numbers=none,
    numberstyle=\tiny,
    stepnumber=1,
    showstringspaces=false,
    tabsize=2,
    breaklines=true,
    breakatwhitespace=false,
    frame=none,
    keywordstyle=\color{blue}\bfseries,
    commentstyle=\color{darkgreen}\itshape,
    stringstyle=\color{red}
}


\chapter{Formal analysis using Alloy}

\section{Alloy Code}


\begin{lstlisting}
    ------ ENUM ------
    
    enum InternshipStatus {WAITING, ONGOING, FINISHED}
    
    ------ DEFINITION OF SIGNATURES ------
    
    abstract sig User {}
    
    sig Student extends User {
        var skills: set Skill,
        university: one University,
        var assignedInternship: lone Internship,
    }
    
    sig Company extends User {
        var activeAdvertisement : set Advertisement,
        var oldAdvertisement : set Advertisement,
        var activeInternships: set Internship,
        var finishedInternships: set Internship,
    }
    
    sig University {
        var students: set Student,
        var monitoredInternships: set Internship,
        var finishedInternships: set Internship,
    }
    
    sig Advertisement {
        requirements: set Skill,
        offeredBy: Company,
        spots: one Int,
        var applicants: set Student,
        var assigned: one Bool,
        internship: set Internship,
    }
    
    sig Internship {
        offeredBy: Company,
        var assignedTo: lone Student,
        var status: one InternshipStatus,
        studentFeedbacks: one Feedback,
        companyFeedbacks: one Feedback,
        complaints: one Complaint,
    }
    
    sig Feedback {
        var evaluator: lone User,
        var recipient: lone User,
        rating: one Rating,
        comment: one TextContent,
    }
    
    sig Complaint {
        var complainer: lone User,
        var target: lone User,
        var details: lone TextContent,
    }
    
    sig Rating {
        var value: lone Int
    } {
        value > 0 and value < 10
    }
    
    -- One skill is associated with a tag, that a student can choose as a personal skill in order to be matched with internships--
    sig Skill {
        tag: one String
    }
    
    sig TextContent {
        var content: lone String
    }
    
    
    ------PREDICATES------
    
    
    
    ------ FACTS ------
    
    fact StudentMustHaveUniversity {
        all s: Student | some s.university
    }
    
    fact UniversityHasOnlyItsStudents {
        all u: University | u.students = {s: Student | s.university = u}
    }
    
    fact UniversityMonitorsOwnInternships {
        all u: University |
            all i: u.monitoredInternships + u.finishedInternships |
                i.assignedTo.university = u
    }
    
    fact AdsAndInternshipsMustHaveCompany {
        all a: Advertisement | some a.offeredBy
        all i: Internship | some i.offeredBy
    }
    
    -- A student participating in an Internship cannot apply for another Internship --
    fact StudentNoConcurrentInternships {
        all s: Student |
            some s.assignedInternship =>
                all a: Advertisement | 
                    (a in s.assignedInternship.internship) or (s not in a.applicants)
    }
    
    fact NoDuplicateApplications {
        all a: Advertisement | all s: Student | s in a.applicants => lone s
    }
    
    fact NoDuplicateUniversityEnrollment {
        all u: University | all s: u.students | lone s
    }
    
    -- Ensures that the number of Internship positions matches the number of available spots in each Advertisement --
    fact AdvertisementSpotsMatchInternships {
        all a: Advertisement | #a.internship = a.spots
    }
    
    -- Guarantees that a Student assigned to an Internship appears in the applicants list for the relevant Advertisement --
    fact AssignedStudentMustBeApplicant {
        all i: Internship | 
            some i.assignedTo => i.assignedTo in i.offeredBy.activeAdvertisement.applicants
    }
    
    -- When an Internship status is FINISHED, there must be a student feedback given to the company by the assigned student --
    fact StudentFeedbackOnCompletion {
        all i: Internship | 
            i.status = FINISHED =>
                some i.studentFeedbacks and
                i.studentFeedbacks.evaluator = i.assignedTo and
                i.studentFeedbacks.recipient = i.offeredBy
    }
    
    -- When an Internship status is FINISHED, there must be a company feedback given to the student by the company --
    fact CompanyFeedbackOnCompletion {
        all i: Internship | 
            i.status = FINISHED =>
                some i.companyFeedbacks and
                i.companyFeedbacks.evaluator = i.offeredBy and
                i.companyFeedbacks.recipient = i.assignedTo
    }
    
    fact ComplaintDirectionOrNone {
        all c: Complaint |
            (c.complainer in Student and c.target in Company) or
            (c.complainer in Company and c.target in Student) or
            (no c.complainer and no c.target)
    }

    -- If an Advertisement is unassigned, its Internships must also be unassigned and in WAITING status --
    fact UnassignedAdvertisementConditions {
        all a: Advertisement | 
            a.assigned = false =>
                all i: a.internship | 
                    no i.assignedTo and i.status = WAITING
    }
    
    -- If an Internship is in WAITING or ASSIGNED status, Feedback fields should be none, without evaluator, recipient, rating, or content --
    fact NoFeedbackDetailsBeforeCompletion {
        all i: Internship |
            i.status in (WAITING + ASSIGNED) =>
                no i.studentFeedbacks.evaluator and 
                no i.studentFeedbacks.recipient and
                no i.studentFeedbacks.rating.value and
                no i.studentFeedbacks.comment.content and
                no i.companyFeedbacks.evaluator and 
                no i.companyFeedbacks.recipient and
                no i.companyFeedbacks.rating.value and
                no i.companyFeedbacks.comment.content
    }
    
    -- If the Internship status is WAITING, all fields in Complaint should be set to none--
    fact NoComplaintDetailsWhenWaiting {
        all i: Internship |
            i.status = WAITING =>
                no i.complaints.complainer and
                no i.complaints.target and
                no i.complaints.details.content
    }
    
    -- In a University, an Internship can be either monitored or finished, but not both--
    fact UniversityInternshipStatus {
        all u: University |
            no u.monitoredInternships & u.finishedInternships
    }
    
    --All Internships in the ONGOING state must appear in the monitoredInternships list of the university associated with the relevant student --
    fact OngoingInternshipsMonitoredByUniversity {
        all i: Internship |
            i.status = ASSIGNED => 
                i in i.assignedTo.university.monitoredInternships
    }
    
    --All Internships in the ONGOING state must appear in the activeInternships list of their respective company--
    fact OngoingInternshipsInCompanyList {
        all i: Internship |
            i.status = ASSIGNED =>
                i in i.offeredBy.activeInternships
    }
    
    --All Internships in the FINISHED state must appear in the finishedInternships list of the university associated with the relevant student--
    fact FinishedInternshipsInUniversity {
        all i: Internship |
            i.status = FINISHED =>
                i in i.assignedTo.university.finishedInternships
    }
    
    --All Internships in the FINISHED state must appear in the finishedInternships list of their respective company--
    fact FinishedInternshipsInCompany {
        all i: Internship |
            i.status = FINISHED =>
                i in i.offeredBy.finishedInternships
    }
    
    --All Internships in the WAITING state must not appear in the monitoredInternships list of the university or in any internship lists of the company--    
    fact WaitingInternshipsNotMonitored {
        all i: Internship |
            i.status = WAITING =>
                (i not in i.assignedTo.university.monitoredInternships) and
                (i not in i.offeredBy.activeInternships) and
                (i not in i.offeredBy.finishedInternships)
    }
    
    --If an Advertisement is assigned, it must appear in the activeAdvertisement list of the company; if not assigned, it must appear in the oldAdvertisement list of the company--
    fact AdvertisementPlacementByAssignment {
        all a: Advertisement |
            (a.assigned = true => a in a.offeredBy.activeAdvertisement) and
            (a.assigned = false => a in a.offeredBy.oldAdvertisement)
    }
    
    --An Internship should not appear in both monitoredInternships and finishedInternships for a University--
    fact NoDuplicateInternshipInUniversity {
        all u: University |
            no u.monitoredInternships & u.finishedInternships
    }

    fact UniqueAdvertisementForEachInternship {
        all i: Internship | 
            one a: Advertisement | i in a.internship
    }

    --An Internship should not appear in both activeInternships and finishedInternships for a Company--
    fact NoDuplicateInternshipInCompany {
        all c: Company |
            no c.activeInternships & c.finishedInternships
    }

\end{lstlisting}
    
